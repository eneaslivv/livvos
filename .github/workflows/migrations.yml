name: Database Migrations

on:
  push:
    branches: [main, develop]
    paths: ['migrations/**', 'scripts/**']
  pull_request:
    branches: [main]
    paths: ['migrations/**', 'scripts/**']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options: ['staging', 'production']
      force:
        description: 'Force migration despite errors'
        required: false
        default: false
        type: boolean
      dry_run:
        description: 'Dry run (preview only)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  POSTGRES_VERSION: '15'

jobs:
  # =============================================
  # VALIDATION JOB
  # =============================================
  validate:
    name: Validate Migrations
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Validate migration files
        run: |
          npm run validate:migrations || {
            echo "âŒ Migration validation failed"
            exit 1
          }
          echo "âœ… Migration validation passed"
        
      - name: Check migration dependencies
        run: |
          npm run check:dependencies || {
            echo "âŒ Migration dependency check failed"
            exit 1
          }
          echo "âœ… Migration dependencies validated"
          
      - name: Lint migration files
        run: |
          npm run lint:migrations || {
            echo "âŒ Migration linting failed"
            exit 1
          }
          echo "âœ… Migration linting passed"
          
      - name: SQL syntax validation
        run: |
          npm run validate:sql || {
            echo "âŒ SQL syntax validation failed"
            exit 1
          }
          echo "âœ… SQL syntax validation passed"

  # =============================================
  # TEST DATABASE JOB
  # =============================================
  test-migrations:
    name: Test Migrations
    runs-on: ubuntu-latest
    needs: validate
    
    services:
      postgres:
        image: postgres:${{ env.POSTGRES_VERSION }}
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Wait for database
        run: |
          timeout 60 bash -c 'until pg_isready -h localhost -p 5432; do sleep 1; done'
          
      - name: Setup test database
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        run: |
          npm run setup:test-db
          
      - name: Run migration tests
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          NODE_ENV: test
        run: |
          npm run test:migrations || {
            echo "âŒ Migration tests failed"
            exit 1
          }
          echo "âœ… Migration tests passed"
          
      - name: Test rollback scenarios
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          NODE_ENV: test
        run: |
          npm run test:rollback || {
            echo "âŒ Rollback tests failed"
            exit 1
          }
          echo "âœ… Rollback tests passed"
          
      - name: Generate migration report
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        run: |
          npm run report:migrations > migration-report.json
          echo "ðŸ“Š Migration report generated"

  # =============================================
  # STAGING DEPLOYMENT JOB
  # =============================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [validate, test-migrations]
    if: github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch'
    environment: staging
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Deploy migrations to staging
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
          SUPABASE_URL: ${{ secrets.STAGING_SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.STAGING_SUPABASE_SERVICE_KEY }}
          ENVIRONMENT: staging
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          FORCE_RUN: ${{ github.event.inputs.force || 'false' }}
        run: |
          chmod +x scripts/deploy-migrations.sh
          
          if [[ "$DRY_RUN" == "true" ]]; then
            echo "ðŸ” Running in DRY RUN mode"
          else
            echo "ðŸš€ Deploying to STAGING environment"
          fi
          
          ./scripts/deploy-migrations.sh \
            --env staging \
            ${DRY_RUN:+--dry-run} \
            ${FORCE_RUN:+--force}
            
      - name: Run health checks
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
          SUPABASE_URL: ${{ secrets.STAGING_SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.STAGING_SUPABASE_SERVICE_KEY }}
        run: |
          npm run health:check || {
            echo "âŒ Health checks failed"
            exit 1
          }
          echo "âœ… Health checks passed"
          
      - name: Verify deployment
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
          SUPABASE_URL: ${{ secrets.STAGING_SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.STAGING_SUPABASE_SERVICE_KEY }}
        run: |
          npm run verify:deployment || {
            echo "âŒ Deployment verification failed"
            exit 1
          }
          echo "âœ… Deployment verified"
          
      - name: Notify on success
        if: success()
        run: |
          echo "ðŸŽ‰ Staging deployment successful!"
          echo "Migration completed at: $(date)"
          
      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Staging deployment failed!"
          echo "Please check the logs and rollback if necessary"

  # =============================================
  # PRODUCTION DEPLOYMENT JOB
  # =============================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [validate, test-migrations]
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Production deployment checklist
        run: |
          echo "ðŸ“‹ Production Deployment Checklist"
          echo "================================"
          echo "âœ… Code reviewed and approved"
          echo "âœ… Tests passing"
          echo "âœ… Migration validated"
          echo "âœ… Backup plan ready"
          echo "âœ… Rollback procedure tested"
          echo ""
          
      - name: Create database backup
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
          SUPABASE_URL: ${{ secrets.PRODUCTION_SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.PRODUCTION_SUPABASE_SERVICE_KEY }}
        run: |
          echo "ðŸ—„ï¸ Creating production database backup..."
          npm run backup:production || {
            echo "âŒ Production backup failed - aborting deployment"
            exit 1
          }
          echo "âœ… Production backup created"
          
      - name: Deploy migrations to production
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
          SUPABASE_URL: ${{ secrets.PRODUCTION_SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.PRODUCTION_SUPABASE_SERVICE_KEY }}
          ENVIRONMENT: production
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          FORCE_RUN: ${{ github.event.inputs.force || 'false' }}
        run: |
          chmod +x scripts/deploy-migrations.sh
          
          if [[ "$DRY_RUN" == "true" ]]; then
            echo "ðŸ” Running in DRY RUN mode for production"
          else
            echo "ðŸš€ Deploying to PRODUCTION environment"
            echo "âš ï¸  This will modify the production database!"
          fi
          
          # Additional safety checks for production
          if [[ "$DRY_RUN" != "true" && "$FORCE_RUN" != "true" ]]; then
            echo "âš ï¸  Production deployment requires manual confirmation or FORCE_RUN=true"
            echo "Please review the changes carefully before proceeding"
            exit 1
          fi
          
          ./scripts/deploy-migrations.sh \
            --env production \
            ${DRY_RUN:+--dry-run} \
            ${FORCE_RUN:+--force}
            
      - name: Comprehensive production health checks
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
          SUPABASE_URL: ${{ secrets.PRODUCTION_SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.PRODUCTION_SUPABASE_SERVICE_KEY }}
        run: |
          echo "ðŸ” Running comprehensive production health checks..."
          
          # Basic connectivity
          npm run health:check || {
            echo "âŒ Basic health checks failed"
            exit 1
          }
          
          # Application-specific checks
          npm run health:application || {
            echo "âŒ Application health checks failed"
            exit 1
          }
          
          # Performance checks
          npm run health:performance || {
            echo "âŒ Performance health checks failed"
            exit 1
          }
          
          # Data integrity checks
          npm run health:integrity || {
            echo "âŒ Data integrity checks failed"
            exit 1
          }
          
          echo "âœ… All production health checks passed"
          
      - name: Verify production deployment
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
          SUPABASE_URL: ${{ secrets.PRODUCTION_SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.PRODUCTION_SUPABASE_SERVICE_KEY }}
        run: |
          npm run verify:production || {
            echo "âŒ Production deployment verification failed"
            echo "ðŸš¨ Immediate rollback may be required!"
            exit 1
          }
          echo "âœ… Production deployment verified"
          
      - name: Generate deployment report
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
          SUPABASE_URL: ${{ secrets.PRODUCTION_SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.PRODUCTION_SUPABASE_SERVICE_KEY }}
        run: |
          npm run report:production > production-deployment-report.json
          echo "ðŸ“Š Production deployment report generated"
          
      - name: Notify on success
        if: success()
        run: |
          echo "ðŸŽ‰ Production deployment successful!"
          echo "Migration completed at: $(date)"
          echo "Database is ready for production use"
          
      - name: Notify on failure with rollback instructions
        if: failure()
        run: |
          echo "âŒ Production deployment failed!"
          echo ""
          echo "ðŸš¨ IMMEDIATE ACTION REQUIRED:"
          echo "1. Check the deployment logs above"
          echo "2. Assess the current database state"
          echo "3. If necessary, perform emergency rollback:"
          echo "   npm run rollback:production"
          echo "4. Notify the team of the incident"
          echo "5. Create incident report"
          echo ""
          echo "ðŸ“ž Emergency contact: on-call engineer"

  # =============================================
  # SECURITY SCAN JOB
  # =============================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run SQL security scan
        run: |
          npm run security:scan || {
            echo "âŒ Security scan found issues"
            exit 1
          }
          echo "âœ… Security scan passed"
          
      - name: Check for sensitive data exposure
        run: |
          npm run security:sensitive || {
            echo "âŒ Sensitive data exposure found"
            exit 1
          }
          echo "âœ… No sensitive data exposure detected"
          
      - name: Validate RLS policies
        run: |
          npm run security:rls || {
            echo "âŒ RLS policy validation failed"
            exit 1
          }
          echo "âœ… RLS policies validated"

  # =============================================
  # NOTIFICATION JOB
  # =============================================
  notify:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: [validate, test-migrations, security-scan]
    if: always()
    
    steps:
      - name: Prepare notification
        id: prepare
        run: |
          if [[ "${{ needs.validate.result }}" == "success" && \
                "${{ needs.test-migrations.result }}" == "success" && \
                "${{ needs.security-scan.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=All migration checks passed âœ…" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=Migration checks failed âŒ" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          fi
          
      - name: Send Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "Migration Pipeline ${{ steps.prepare.outputs.status }}",
              "attachments": [{
                "color": "${{ steps.prepare.outputs.color }}",
                "fields": [{
                  "title": "Repository",
                  "value": "${{ github.repository }}",
                  "short": true
                }, {
                  "title": "Branch",
                  "value": "${{ github.ref_name }}",
                  "short": true
                }, {
                  "title": "Commit",
                  "value": "${{ github.sha }}",
                  "short": true
                }, {
                  "title": "Message",
                  "value": "${{ steps.prepare.outputs.message }}",
                  "short": false
                }],
                "actions": [{
                  "type": "button",
                  "text": "View Workflow",
                  "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                }]
              }]
            }' \
            "$SLACK_WEBHOOK_URL"
            
      - name: Send Discord notification
        if: env.DISCORD_WEBHOOK_URL != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "content": "Migration Pipeline ${{ steps.prepare.outputs.status }}",
              "embeds": [{
                "title": "Migration Pipeline Results",
                "description": "${{ steps.prepare.outputs.message }}",
                "color": ${{ steps.prepare.outputs.status == 'success' && '3066993' || '15158332' }},
                "fields": [
                  {"name": "Repository", "value": "${{ github.repository }}", "inline": true},
                  {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                  {"name": "Commit", "value": "${{ github.sha }}", "inline": true}
                ],
                "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }]
            }' \
            "$DISCORD_WEBHOOK_URL"